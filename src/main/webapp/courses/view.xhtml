<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE composition PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns:ui="http://java.sun.com/jsf/facelets"
                template="./../WEB-INF/templates/default.xhtml"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:my="http://java.sun.com/jsf/composite/iudex"
                xmlns:c="http://java.sun.com/jsp/jstl/core"
				xmlns:p="http://primefaces.org/ui">
	<f:metadata>
		<f:event type="preRenderView" listener="#{viewCourse.preRenderView()}" />
	</f:metadata>
	<ui:define name="content">
		<h:outputStylesheet library="css" name="style_courses.css" />
		<div class="container comments-container">


			<!--Professor bar --> 
			<div class="well span4 container-fluid fixed-navbar" >
				<div class="row-fluid">
					<div class="span7 " style="text-align: center; line-height: 200%">
						<h:outputText class="fittext-subject fittext" value="#{viewCourse.course.subject.name}"/>
					</div>
					<div class="span4 container-fluid cuadro-promedio" >
						<div class="row-fluid">
							<h:outputText id="fittext-rating-title" class="fittext" value="PROMEDIO"/>
						</div>
						<div class="row-fluid" >
							<div class="span6" style="margin-top: 10%;">
								<h:outputText id="fittext-rating" class="fittext" value="#{viewCourse.course.ratingAverage}"/>
							</div>
							<div class="span6">
								<img style="vertical-align: middle;" src="#{request.contextPath}/resources/images/star.png" />
							</div>
						</div>
						<div class="row-fluid">
							<h:outputText id="fittext-rating-info" class="fittext" value="#{viewCourse.course.ratingCount} personas han votado"/>
						</div>
					</div>
				</div>
				<div class="row">
					<div class="professor-photo thumbnail" >
						<a href=""><img src="#{viewCourse.professor.imageUrl}"/></a>
						<div id="professor-photo-caption"><h5><a href="#{viewCourse.course.professor.website}">#{viewCourse.course.professor.fullName}</a></h5></div>
						<ul class="actions">
							<li class="upvote-prof"><a href="#" class="icon-thumbs-up"></a></li>
							<li class="downvote-prof"><a href="#" class="icon-thumbs-down"></a></li>
						</ul>
						<div>
						</div>
					</div>
				</div>
				<div class="row comments-control">
					<h3> Filtrar comentarios por calificación del curso: </h3>
					<div class="btn-group" data-toggle="buttons-checkbox">
						<a class="btn btn-primary active" onclick="$('.comment-star5').toggle('slow')">5</a>
						<a class="btn btn-primary active" onclick="$('.comment-star4').toggle('slow')">4</a>
						<a class="btn btn-primary active" onclick="$('.comment-star3').toggle('slow')">3</a>
						<a class="btn btn-primary active" onclick="$('.comment-star2').toggle('slow')">2</a>
						<a class="btn btn-primary active" onclick="$('.comment-star1').toggle('slow')">1</a>
					</div>
				</div>

			</div><!--/.well -->

			<!--End of Professor bar --> 

			<ui:fragment  rendered="#{user.loggedIn}">
				<div class="row ">
					<div class="offset5 span7 ">
						<div class="row-fluid">
							<h:form id="courseRatingForm" class="well">
								<h:outputText value="CALIFICA EL CURSO" class="span6 fittext-rateInput"/>  
								<div class="span6">
									<p:rating value="#{viewCourse.courseRating}" onRate="showCommentInput()" >  
										<p:ajax event="rate" listener="#{viewCourse.handleRate}" update="messages,:fittext-rating,:fittext-rating-info,:courseCommentForm:new-comment-rating" oncomplete="updatedRating()"/>
									</p:rating>  
								</div>
								<p:growl id="messages" showDetail="true"/> 
							</h:form>
						</div>
						<div class="row-fluid hidden" id="commentInput">
							<!-- Beginning of comment -->
							<h:form id="courseCommentForm">
								<div class="row-fluid">
									<div class="comment span12">
										<div class="comment-container span12">
											<h:panelGroup layout="block" class="comment-rating" id="new-comment-rating">
												<span>Calificación del curso :</span>
												<ui:repeat var="i" value="#{utils.buildArrayCeil(viewCourse.courseRating)}">
													<span class="star"/>
												</ui:repeat>

											</h:panelGroup>
											<div class="comment-photo thumbnail">
												<img src="#{request.contextPath}#{user.imageUrl}"/>
												<h4>#{user.firstName}</h4>
												<span class="fittext fittext-coment-program">#{utils.parseProgramName(user.programId)}</span>
											</div>
											<p>
												<h:inputTextarea class="comment-content" value="#{createComment.content}"/>
											</p>
										</div>
										<div class="span12">
											<div id="anonymous-control" class="span7">
												<span>"¿Deseas que este comentario sea anónimo?"</span>
												<p:selectBooleanButton value="#{createComment.anonymous}" onLabel="Sí" offLabel="No" />
											</div>
											<div class="span4">
												<h:commandLink action="#{createComment.createComment()}" class="btn btn-large " value="Comentar">
													<i class="icon-comment"></i>
													<f:ajax onevent="hideCommentBox()" execute="@form"/>
												</h:commandLink>
											</div>
										</div>
									</div>

								</div><!--/row-->
								<!-- Ending of comment -->
							</h:form>
						</div>
					</div>
				</div>
			</ui:fragment>
			<div class="row">
				<div class="offset5 span7">
					<h:form id="voteForm">
						<ui:repeat var="comment" value="#{viewCourse.comments}" varStatus="status">
							<!-- Beginning of comment -->
							<div class="row-fluid comment-star#{utils.ceil(comment.courseRating)}">
								<div class="comment span12">
									<div class="comment-container span12">
										<div class="comment-rating">
											<span>Calificación del curso : </span>
											<ui:repeat var="i" value="#{utils.buildArrayCeil(comment.courseRating)}">
												<span class="star"/>
											</ui:repeat>
										</div>
										<div class="comment-photo thumbnail">
											<img src="#{request.contextPath}#{comment.user.imageUrl}" alt="profesor x" />
											<h4>#{comment.user.name}</h4>
											<span class="fittext fittext-coment-program">#{comment.user.mainProgram}</span>
										</div>
										<p>
											#{comment.content}
										</p>

										<!-- Begin voting form for registered users -->
										<h:panelGroup id="voteCount" class="vote" rendered="#{user.loggedIn}">
											<div class="#{(viewCourse.parseUserCommentVote(comment.id)==1?'':'vote-wrapper')}"><h:commandLink action="#{rating.votePositiveComment(comment)}" class="upvote"><f:ajax event="action" execute="@form" render="voteCount" onevent="onVote"/></h:commandLink> </div>
											<div class="#{(viewCourse.parseUserCommentVote(comment.id)!=0?'':'vote-wrapper')}">
												<span class="vote-count" rel="popover" data-content="#{comment.rating.positive+comment.rating.negative} han votado por este comentario" data-original-title="Votos">#{comment.rating.positive-comment.rating.negative}</span>
											</div>
											<div class="#{(viewCourse.parseUserCommentVote(comment.id)==-1?'':'vote-wrapper')}"><h:commandLink action="#{rating.voteNegativeComment(comment)}" class="downvote"><f:ajax event="action" execute="@form" render="voteCount" onevent="onVote"/>                            
												</h:commandLink>
											</div>
										</h:panelGroup>
										<!-- End voting form for registered users -->
										<!-- Begin voting form for NOT registered users -->
										<h:panelGroup class="vote" rendered="#{!user.loggedIn}">
											<div class="vote-wrapper"><a class="upvote not-registered" rel="popover" data-content="Debes estar registrado para poder votar por los comentarios." data-original-title="Da click para registrarte o iniciar sesión" href="#{request.contextPath}/logIn.xhtml"/></div>
											<div class="vote-wrapper">
												<span class="vote-count" rel="popover" data-content="#{comment.rating.positive+comment.rating.negative} han votado por este comentario" data-original-title="Votos">#{comment.rating.positive-comment.rating.negative}</span>
											</div>
											<div class="vote-wrapper"><a class="downvote not-registered" rel="popover" data-content="Debes estar registrado para poder votar por los comentarios." data-original-title="Da click para registrarte o iniciar sesión" href="#{request.contextPath}/logIn.xhtml"/></div>
										</h:panelGroup>
										<!-- End voting form for NOT registered users -->
									</div>
									<div class="comment-report">
										<span class=""><a href="#">Reportar comentario</a></span>
									</div>

								</div>

							</div><!--/row-->
							<!-- Ending of comment -->
						</ui:repeat>
					</h:form>
				</div><!--/span-->
			</div><!--/row-->




		</div>
		<script type="text/javascript">
			//Beginning of fittext code
			$(".fittext-subject").fitText(0.7);
			$(".fittext-rateInput").fitText(1.1);
			$(".fittext-coment-program").fitText(1.1);
			//End of fittext code
			function showCommentInput(){
				//If it was hidden from the begining, it was using the hidden class
				// but before removing the class hide it with jquery.
				$("#commentInput").hide();
				$("#commentInput").removeClass("hidden");
				//Now show it
				$("#commentInput").show("slow");

			}
			function hideCommentBox(){
				$('#commentInput').hide('slow');
			}
			$('.not-registered').popover();
			$('.vote-count').popover();
			function onVote(e){
				$('.vote-count').popover();
			}
			function updatedRating(){
				$("#fittext-rating").fitText(0.15);
				$("#fittext-rating-title").fitText(0.4);
				$("#fittext-rating-info").fitText(0.6);

			}
			updatedRating();
			//This snippet allows multiple JSF forms to work at a time in the same page
			window.myfaces = window.myfaces || {};
			myfaces.config = myfaces.config || {};
			//set the config part
			myfaces.config.no_portlet_env = true; 
			//End of snippet. Source : http://www.irian.at/en/blog/-/blogs/jsf-ajax-and-multiple-forms
		</script>
	</ui:define>


</ui:composition>
